name: CI/CD to Docker Hub and EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    # ... (Your existing build-and-push job remains here)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/edu-backend:latest ./backend
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/edu-backend:latest

      - name: Build and push frontend image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/edu-frontend:latest ./frontend
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/edu-frontend:latest
          
  # --- DEPLOYMENT JOB ---
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5 # 1. Checkout to access docker-compose.yml

      - name: Copy Docker Compose file to EC2
        # 2. FIX: Transfers docker-compose.yml to the EC2 instance's home directory
        uses: appleboy/scp-action@v0.1.7 
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # Source is the root directory file, Target is the user's home directory
          source: "docker-compose.yml" 
          target: "/home/${{ secrets.EC2_USERNAME }}" 

      - name: Deploy on EC2 via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # --- INSTALL DOCKER (FIX: Addresses "docker: command not found") ---
            # This block ensures Docker is installed for the first run or if it was removed.
            if ! command -v docker &> /dev/null
            then
                echo "Docker not found. Installing..."
                # Quick, reliable Docker install for most Ubuntu/Debian based systems
                curl -fsSL https://get.docker.com -o get-docker.sh
                sudo sh get-docker.sh
                
                # Add the user to the docker group for permission management
                sudo usermod -aG docker ${{ secrets.EC2_USERNAME }}
                
                echo "Docker installation complete. Waiting 5 seconds..."
                sleep 5
            else
                echo "Docker is already installed."
            fi
            
            # --- DEPLOYMENT ---
            cd /home/${{ secrets.EC2_USERNAME }} # CD to the directory containing docker-compose.yml

            # Use 'sudo' for Docker commands as group changes may not be active in this session
            sudo docker compose down
            sudo docker image prune -af

            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/edu-backend:latest
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/edu-frontend:latest

            sudo docker compose up -d # This should now succeed!